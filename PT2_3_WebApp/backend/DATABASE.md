# Database Documentation

## Overview
MongoDB database สำหรับระบบจัดการสินค้า XSurface

---

## Collections

### Products Collection

#### Schema Structure
```javascript
{
  "_id": ObjectId,           // MongoDB generated ID
  "name": String,            // ชื่อสินค้า (required)
  "code": String,            // รหัสสินค้า (required, unique)
  "price": Number,           // ราคา (required, >= 0)
  "category": String,        // หมวดหมู่ (optional)
  "description": String,     // คำอธิบายสินค้า (optional)
  "image": String,           // URL รูปภาพหลัก (required)
  "images": [String],        // URL รูปภาพเพิ่มเติม (optional)
  "createdAt": Date,         // วันที่สร้าง (auto-generated)
  "updatedAt": Date          // วันที่แก้ไข (auto-generated)
}
```

#### Field Details

**name** (String, required)
- ชื่อสินค้าภาษาไทย/อังกฤษ
- มี trim เพื่อลบช่องว่าง
- ใช้ใน text search

**code** (String, required, unique)
- รหัสสินค้า เช่น "PVKA-ST-001"
- ห้ามซ้ำกัน (unique constraint)
- มี trim เพื่อลบช่องว่าง  
- ใช้ใน text search

**price** (Number, required)
- ราคาสินค้าเป็นบาท
- ต้อง >= 0 (min validation)
- แสดงเป็นทศนิยม 2 ตำแหน่ง

**category** (String, optional)
- หมวดหมู่สินค้า:
  - "UPVC/VPVC" - แผ่นพลาสติก
  - "Tile" - กระเบื้อง
  - "Stone" - หิน/หินอ่อน
  - "Wood" - ไม้
  - "Mirror" - กระจก
  - "WPC" - ไม้เทียม
  - "Metal" - โลหะ
  - "Wallpaper" - วอลล์เปเปอร์

**description** (String, optional)
- คำอธิบายรายละเอียดสินค้า
- มี trim เพื่อลบช่องว่าง

**image** (String, required)
- URL รูปภาพหลัก
- ใช้ via.placeholder.com สำหรับ mock data
- แนะนำขนาด 400x300 pixels

**images** (Array of String, optional)
- URL รูปภาพเพิ่มเติม
- สามารถมีหลายรูป
- ใช้สำหรับแสดง gallery

---

## Indexes

### Text Search Index
```javascript
{ name: "text", code: "text" }
```
- ใช้ค้นหาสินค้าจาก name หรือ code
- รองรับ Thai/English text search
- Case-insensitive search

### Unique Index
```javascript
{ code: 1 }
```
- รหัสสินค้าห้ามซ้ำ
- Auto-generated by unique constraint

---

## Sample Data

### UPVC/VPVC Products
```javascript
{
  "name": "PVKA (Stana)",
  "code": "PVKA-ST-001", 
  "price": 850,
  "category": "UPVC/VPVC",
  "description": "แผ่น UPVC คุณภาพสูง ทนทาน กันน้ำ",
  "image": "https://via.placeholder.com/400x300/667eea/ffffff?text=PVKA+Stana"
}
```

### Tile Products
```javascript
{
  "name": "Ceramic Tile Premium",
  "code": "TILE-PR-001",
  "price": 650, 
  "category": "Tile",
  "description": "กระเบื้องเซรามิค ลายหินอ่อน คุณภาพพรีเมียม",
  "image": "https://via.placeholder.com/400x300/8b5cf6/ffffff?text=Ceramic+Tile"
}
```

---

## Database Operations

### Create Product
```javascript
db.products.insertOne({
  name: "Product Name",
  code: "PRD-001",
  price: 1000,
  category: "Category",
  description: "Description",
  image: "https://image-url.com/image.jpg"
})
```

### Search Products
```javascript
// Text search
db.products.find({ $text: { $search: "PVKA" }})

// Filter by category  
db.products.find({ category: "UPVC/VPVC" })

// Price range
db.products.find({ price: { $gte: 500, $lte: 1000 }})
```

### Update Product
```javascript
db.products.updateOne(
  { code: "PRD-001" },
  { $set: { price: 1200, updatedAt: new Date() }}
)
```

### Delete Product
```javascript
db.products.deleteOne({ code: "PRD-001" })
```

---

## API Endpoints

### GET /api/products
- ดึงสินค้าทั้งหมด
- รองรับ pagination: ?page=1&limit=12
- รองรับ search: ?search=keyword
- รองรับ category filter: ?category=Tile

### GET /api/products/:id
- ดึงสินค้า 1 รายการ
- Parameter: MongoDB ObjectId

### POST /api/products  
- สร้างสินค้าใหม่
- Required: name, code, price, image
- Optional: category, description, images

### PUT /api/products/:id
- แก้ไขสินค้า
- Parameter: MongoDB ObjectId
- Body: fields to update

### DELETE /api/products/:id
- ลบสินค้า
- Parameter: MongoDB ObjectId

### POST /api/products/upload
- อัปโหลดรูปภาพ
- Support: JPG, JPEG, PNG
- Max size: 50MB
- Returns: file URL

---

## Environment Variables

```env
MONGODB_URI=mongodb://localhost:27017/xsurface
NODE_ENV=development
PORT=5000
```

### Production
```env
MONGODB_URI=mongodb+srv://user:pass@cluster.mongodb.net/xsurface
NODE_ENV=production  
PORT=5000
```

---

## Connection Configuration

### Local Development
```javascript
mongoose.connect('mongodb://localhost:27017/xsurface')
```

### Docker
```javascript  
mongoose.connect('mongodb://mongodb:27017/xsurface')
```

### MongoDB Atlas
```javascript
mongoose.connect('mongodb+srv://user:pass@cluster.mongodb.net/xsurface')
```

---

## Seeding Data

### Run Seed Script
```bash
cd backend
npx ts-node src/seed.ts
```

### Seed Data Summary
- **Total Products**: 20 items
- **Categories**: 8 categories
- **Price Range**: 450 - 2,800 บาท
- **Images**: via.placeholder.com with category colors

### Category Distribution
- UPVC/VPVC: 3 products
- Tile: 3 products  
- Stone: 2 products
- Wood: 2 products
- Mirror: 2 products
- WPC: 3 products
- Metal: 3 products
- Wallpaper: 2 products

---

## Performance

### Query Performance
- Text search: ~2-5ms (20 products)
- Category filter: ~1-2ms  
- Pagination: ~1-3ms
- Single product: ~0.5-1ms

### Optimization
- Use indexes for frequent queries
- Limit returned fields if not needed
- Implement caching for static data
- Use aggregation pipeline for complex queries

---

## Backup & Restore

### Backup
```bash
docker exec mongodb mongodump --out /backup/$(date +%Y%m%d)
```

### Restore  
```bash
docker exec -i mongodb mongorestore /backup/20260115
```

### Automated Backup (Cron)
```bash
0 2 * * * docker exec mongodb mongodump --out /backup/$(date +\%Y\%m\%d) && find /backup -mtime +7 -delete
```

---

**Database Version**: MongoDB 5.0+
**Last Updated**: January 15, 2026